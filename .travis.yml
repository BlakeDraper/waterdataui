language: python

python:
  - "3.6.5"

addons:
  firefox: "latest"
  browserstack:
    username: "danielnaab3"
    access_key:
      secure: "f4cjLVC5ORAFkpK4kv/1fHP916vVC/y4EvakM1o25vrwb0/BDWNkxAgsGWVMS6XBDGd4XFtfcrY9seagRw3yUJ0lZU4PCIwxd7vDnORZBjIWRd/XzsRFBLIMajePLpGfyM+l4eyCE/AeE2qLKZgOqGMIjPHpesP6vF6gIwTxJjvhypt3bLYZJMdaN/+xFjnOpFS/wNQKBTnP8w6ZDh82JD1YNKCmLJ5ET4KCHnj0VzcJ9NP9HAzoPzgaAX6euR1iVN3KlmvSfiaWgVGLhcn6wbvQ3TdmFIFsXRt8GPv6ExhKDcFZak1J7QWjq2xIQqWD58rH06rs+sMuwjnZaOSi7Kiiv6t52z48nH8zbOywiVal6PhVsN62X2uquFhuEyFFdlwRgb/DuGeEC4yYj+yeAn1YOO8YtjZRjEY2VkgpHLGPQqIDt7RqYjssHwfr/yodOyLeDmex5pV2sP8zWZbqKaT6SvmnSQhEHaCHzTGbKgXA7E6zSQ2oafizk5jiOJ8QEdVoHUqnWT+LdxJsFeMXGXg/5WfYA7hbneq2PJ5UTTkGvoU0ZbcB8t4rwjVaRd+dWPsn3H2AAD0egCj+nef7PgkTHdb8jGzNB27e6HXSPfLRgSeYplSQix+71G2OCYzHStN46x7aPxUIdAs3RPPCuvjil8kzfcIdVFKiK3eCHiI="


before_install:
  - nvm install $(python -c "import json; print(json.loads(open('./assets/package.json').read())['engines']['node'])")

install:
  - make env
  - gem install coveralls-lcov

before_script:
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - mkdir coverage

script:
  - wdfn-server/env/bin/coverage run --omit=wdfn-server/waterdata/tests/*.py,wdfn-server/env/* -m pytest wdfn-server/waterdata
  - cd assets && KARMA_BROWSERSTACK=1 npm run test

after_success:
  - cd ../
  - find assets/coverage/ -mindepth 2 -iname '*.info' -exec cp -t coverage/ '{}' +
  - coveralls-lcov -v -n coverage/lcov.info > coverage/coverage.json
  - wdfn-server/env/bin/coveralls --merge=coverage/coverage.json
